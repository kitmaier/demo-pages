<html>
<body>
<!--
<button type="button" onclick ="buttonClick1()" style="font-size:50px;">Click Me!</button>
<button type="button" onclick ="buttonClick2()" style="font-size:50px;">Click Me!</button>
<select id="numberSelect" name="selectedNumber" onchange="selectNumber()" style="font-size:50px;">
  <option value="0">0</option>
  <option value="1" selected>1</option>
  <option value="2">2</option>
  <option value="3">3</option>
  <option value="4">4</option>
</select>
-->
<p/>
<svg id="svg" height="600" width="800" xmlns="http://www.w3.org/2000/svg">
</svg>
</body>
<script>
var svg = document.getElementById("svg");

/*

Alternative Koch island / Gosper lake fractals from The Fractal Geometry of Nature page 48


*/

var selectedMValues = [4,8,16,32];
var unitPoints = new Map();

/*
Generating the basic unit shape
*---*
     \
      \
       *---*
where the points are (0,0),(1,0),(1+A,-B),(2+A,-B)
If the angle of the second segment below the horizontal is T=2PI/M a subdivision of the circle of ratio 1/M with M>=4 then A = cos(T) and B = sin(T) and A^2+B^2=1
The squared length L2 of (2+A,-B) is L2=(2+A)(2+A)+B^2=4+4A+A^2+B^2=5+4A
The inverse of (2+A,-B) as a complex number is (1/L2)*(2+A,B)
The goal now is to rotate and scale the unit shape so that the endpoints are at (0,0) and (1,0)
The second target point moves to (1,0)*(1/L2)*(2+A,B)=(1/L2)*(2+A,B)
The third target point moves to (1+A,-B)*(1/L2)*(2+A,B) = (1/L2)*((1+A)(2+A)+B^2,-B) = (1/L2)*(2+3A+A^2+B^2,-B) = (1/L2)*(3+3A,-B)

The second target point is on the circle of radius 1/3 centered at (2/3,0)
X = (2+A)/(5+4A)
3X(5+4A) = 6+3A
(3X-2)(5+4A) = 6+3A-10-8A = -(4+5A)
X-2/3 = (-1/3)(4+5A)/(5+4A)
Y = B/(5+4A)
3Y(5+4A) = 3B
((3X-2)^2+9Y^2)(5+4A)^2 = (4+5A)^2+9B^2 = 16+40A+25A^2+9B^2 = 25+40A+16A^2 = (5+4A)^2
(X-2/3)^2+Y^2 = (1/3)^2

The third target point is on the circle of radius 1/3 centered at (1/3,0)
X = 3(1+A)/(5+4A)
3X(5+4A) = 9+9A
(3X-1)(5+4A) = 9+9A-5-4A = 4+5A
X-1/3 = (1/3)(4+5A)/(5+4A)
Y = -B/(5+4A)
3Y(5+4A) = -3B
((3X-1)^2+9Y^2)(5+4A)^2 = (4+5A)^2+9B^2 = 16+40A+25A^2+9B^2 = 25+40A+16A^2 = (5+4A)^2
(X-1/3)^2+Y^2 = (1/3)^2

https://en.wikipedia.org/wiki/Circles_of_Apollonius
	Apollonius showed that a circle can be defined as the set of points in a plane that have a specified ratio of distances to two fixed points, known as foci.

*/
function generateUnitPointsFromRatio(M) {
	var theta = 2*Math.PI/M;
	var L2 = 5+4*Math.cos(theta);
	var unitPoints = [[0,0],[0,0],[0,0],[1,0]];
	unitPoints[1][0] = (1/L2)*(2+Math.cos(theta));
	unitPoints[1][1] = (1/L2)*(Math.sin(theta));
	unitPoints[2][0] = 3*(1/L2)*(1+Math.cos(theta));
	unitPoints[2][1] = -1*(1/L2)*(Math.sin(theta));
	return unitPoints;
}

function generateUnitPoints() {
	for(var k=0; k<selectedMValues.length; k++) {
		var M = selectedMValues[k];
		unitPoints.set(M,generateUnitPointsFromRatio(M));
	}
}

generateUnitPoints();

function appendPoint(x,y,polygon) {
	var point = svg.createSVGPoint();
	point.x = x;
	point.y = y;
	polygon.points.appendItem(point);
}

function paintUnitPointsExample() {
	// TODO: copy the polygon creation code here
	for(var M=4; M<=32; M+=4) {
		var unitPoints = generateUnitPointsFromRatio(M);
		for(var k=0; k<4; k++) {
			var p = unitPoints[k];
			appendPoint(500*p[0]+100,500*p[1]+300);
		}
	}
}

//paintUnitPointsExample();


function paintGosperCurve(x1,y1,x2,y2,level,M,polygon) {
	// (a+bi)(c+di) = (ac-bd)+(ad+bc)i
	var c = x2-x1;
	var d = y2-y1;
	var transformedPoints = [[0,0],[0,0],[0,0],[0,0]];
	var points = unitPoints.get(M);
	for(var k=0; k<points.length; k++) {
		var a = points[k][0];
		var b = points[k][1];
		transformedPoints[k][0] = a*c-b*d+x1;
		transformedPoints[k][1] = a*d+b*c+y1;
	}
	for(var k=0; k<transformedPoints.length-1; k++) {
		var p1 = transformedPoints[k];
		var p2 = transformedPoints[k+1];
		if(level==0) {
			appendPoint(p2[0],p2[1],polygon);
		} else {
			paintGosperCurve(p1[0],p1[1],p2[0],p2[1],level-1,M,polygon);
		}
	}
}

function paintGosperLake(R,level,M,color) {
	var polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
	if(color==1) {
		polygon.setAttribute("style", "fill:black;stroke:black;stroke-width:0");
	} else {
		polygon.setAttribute("style", "fill:white;stroke:black;stroke-width:0");
	}
	svg.appendChild(polygon);
	for(var k=0; k<M; k++) {
		var X1 = 400+R*Math.cos((2*Math.PI*k)/M);
		var Y1 = 300+R*Math.sin((2*Math.PI*k)/M);
		var X2 = 400+R*Math.cos((2*Math.PI*(k+1))/M);
		var Y2 = 300+R*Math.sin((2*Math.PI*(k+1))/M);
		paintGosperCurve(X1,Y1,X2,Y2,level,M,polygon);
	}
}

paintGosperLake(1000,6,32,1);
paintGosperLake(400,6,32,0);
paintGosperLake(300,6,16,1);
paintGosperLake(200,6,8,0);
paintGosperLake(150,6,4,1);

// TODO: animate rotations or transformations
// TODO: randomize direction of crinkling
// TODO: randomize angle of crinkling

</script>
</html>